#include "Biochemistry.h"

const uint32_t EVERY[32] = {
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	// these are all powers of two minus one
	1,
	3,
	7,
	15,
	31,
	63,
	127,
	255,
	511,
	1023,
	2047,
	4095,
	8191,
	16383,
	32767,
	65535,
	131071,
	262143,
	524287,
	1048575,
	2097151,
	4194303,
	8388607,
	16777215};

const float MULTIPLIERS[32] = {
	0.0000000000000000,
	0.1978302001953125,
	0.4447784423828125,
	0.6669158935546875,
	0.8166503906250000,
	0.9036865234375000,
	0.9506225585937500,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9749908447265625,
	0.9999847412109375};


uint8_t decay_chemical(uint8_t concentration, uint8_t rate, uint32_t current_biotick) {
	// TODO: this might be faster to keep in the header so the compiler can inline it
	// TODO: move rate into the ChemicalData itself, and only serialize as 0-255 ?
	rate >>= 3;

	auto every = EVERY[rate];
	if ((current_biotick & every) == every) {
		return static_cast<uint8_t>(concentration * MULTIPLIERS[rate]);
	}
	return concentration;
}